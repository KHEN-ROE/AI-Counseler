<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</title>
  <link rel="stylesheet" th:href="@{/boardDetail.css}" />
</head>
<body>

<!-- Navbar -->
<div class="navbar">
  <div class="navbar-brand"><a href="/main" class="title">ê°ì • ì“°ë ˆê¸°í†µ</a></div>
  <div class="navbar-menu">
    <a href="/board/view">ì»¤ë®¤ë‹ˆí‹°</a>
    <a href="#">ë§ˆì´í˜ì´ì§€</a>
    <a href="/members/logout">ë¡œê·¸ì•„ì›ƒ</a>
  </div>
</div>

<div class="container">

  <div class="board-detail">
    <h3 th:if="${board.title != null}" th:text="${board.title}">ì œëª©</h3>
    <p><span th:text="${board.nickname}">ì‘ì„±ì</span> &nbsp; <span th:text="${board.date}">ì‘ì„±ì¼</span></p>
    <div class="board-content">
      <p th:text="${board.text}">ê²Œì‹œê¸€ ë‚´ìš©</p>
    </div>
  </div>


  <a th:href="@{'/board/update/' + ${board.id}}"><button>ìˆ˜ì •</button></a>

  <form th:action="@{'/board/delete/' + ${board.id}}" method="post">
    <button type="submit" class="delete_Btn">ì‚­ì œ</button>
  </form>


  <div class="comments-section">
    <ul>
      <li th:each="comment : ${comments}" th:if="${comment.isDeleted == false}">
        <p><strong th:text="${comment.nickname}">ì‘ì„±ì</strong> &nbsp; <span th:text="${comment.date}"></span></p>

        <div class="comment-content-wrapper">
          <p th:text="${comment.text}" style="flex-grow: 1;">ëŒ“ê¸€ ë‚´ìš©</p>
          <div>

            <!-- ì¢‹ì•„ìš” ì•„ì´ì½˜ ë° ìˆ«ì -->

              <span class="like-icon" th:data-id="${comment.id}" th:data-board-id="${board.id}" onclick="addLike(this)">ğŸ‘</span>
              <span class="like-count" th:text="${comment.likeCount}">0</span>


            <div th:if="${comment.memberId.equals(loginMember)}">
              <button class="editComment" th:data-id="${comment.id}" style="display: inline-block;">ìˆ˜ì •</button>

              <form th:action="@{'/comment/delete'}" method="post" class="comment-button-form" style="display: inline-block;">
                <input type="hidden" name="commentId" th:value="${comment.id}">
                <input type="hidden" name="boardId" th:value="${board.id}">
                <button class="deleteComment" type="submit">ì‚­ì œ</button>
              </form>
            </div>
          </div>
        </div>

        <!-- ëŒ“ê¸€ ìˆ˜ì • í¼ -->
        <div class="edit-comment-form" th:id="'editForm-' + ${comment.id}" style="display:none;">
          <form action="/comment/update" method="post">
            <label>
              <textarea name="text" required th:text="${comment.text}"></textarea>
            </label>
            <input type="hidden" name="commentId" th:value="${comment.id}"/>
            <input type="hidden" name="boardId" th:value="${board.id}"/>
            <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
          </form>
        </div>
      </li>
    </ul>

    <form class="replyArea" action="/comment/add" method="post" th:object="${addAndUpdateCommentDto}">
      <div>
        <label for="text"></label>
        <textarea id="text" name="text" th:field="*{text}" required></textarea>
      </div>
      <!--ìˆ¨ê²¨ì§„ inputí•„ë“œë¡œ boardIdì¶”ê°€-->
      <input type="hidden" name="boardId" th:value="${board.id}" />

      <button type="submit">ëŒ“ê¸€ ì“°ê¸°</button>

    </form>
  </div>

  <div th:if="${errorMessage != null}">
    <p th:text="${errorMessage}"></p>
  </div>

</div>

<script>
  const editButtons = document.querySelectorAll('.editComment');

  editButtons.forEach(button => {
    button.addEventListener('click', function () {
      const commentId = this.dataset.id;
      console.log("commentId", commentId);
      const editForm = document.getElementById('editForm-' + commentId);
      console.log("editForm:", document.getElementById('editForm-' + commentId));
      editForm.style.display = 'block';
    });
  });
</script>

<!-- jQuery ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (Ajax ì‚¬ìš©ì„ ìœ„í•´) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  function addLike(element) {
    // comment id ê°€ì ¸ì˜¤ê¸°
    const commentId = $(element).data('id');
    const boardId = $(element).data('board-id');

    // ë°ì´í„° ì„¤ì •
    const data = {
      boardId: boardId,
      commentId: commentId,
    };

    // Ajax ìš”ì²­
    $.post("/like/add", data, function (response) {
      if (response.error) {
        // ì—ëŸ¬ ì²˜ë¦¬
        alert(response.errorMessage);
      } else {
        // ì¢‹ì•„ìš” ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        updateLikeCount(commentId);
      }
    }).fail(function () {
      alert("ì¢‹ì•„ìš”ëŠ” í•œ ë²ˆë§Œ ê°€ëŠ¥í•´ìš”.");
    });
  }

  function updateLikeCount(commentId) {
    $.get(`/like/get/${commentId}`, function (data) {
      $(`[data-id=${commentId}]`).next(".like-count").text(data);
    }).fail(function () {
      alert("ì¢‹ì•„ìš” ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    });
  }

</script>
</body>
</html>
